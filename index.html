<head>
<link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
<script defer src="https://pyscript.net/latest/pyscript.js"></script>
<link rel="stylesheet" href="css/style.css" />    
<link rel = 'stylesheet' href = "https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css">
 
  <script type="text/javascript">
function copytoclipboard() {
 var copyText = document.getElementById("sbml_output");

  // Select the text field
  copyText.select();
  copyText.setSelectionRange(0, 99999); // For mobile devices

   // Copy the text inside the text field
  navigator.clipboard.writeText(copyText.value);
}
</script>
  
  
</head>

<body>
 
<py-script>
def myadd (a,b):
    return a + b
        
import sys
import re

def lex(characters, token_exprs):
    pos = 0
    tokens = []
    while pos < len(characters):
        match = None
        for token_expr in token_exprs:
            pattern, tag = token_expr
            regex = re.compile(pattern)
            match = regex.match(characters, pos)
            if match:
                text = match.group(0)
                if tag:
                    token = (text, tag)
                    tokens.append(token)
                break
        if not match:
            sys.stderr.write('Illegal character: %s\n' % characters[pos])
            sys.exit(1)
        else:
            pos = match.end(0)
    return tokens

RESERVED = 'RESERVED'
INT      = 'INT'
ID       = 'ID'

token_exprs = [
    (r'[ \n\t]+',              None),
    (r'#[^\n]*',               None),
    (r'\:=',                   RESERVED),
    (r'\(',                    RESERVED),
    (r'\)',                    RESERVED),
    (r';',                     RESERVED),
    (r'\+',                    RESERVED),
    (r'-',                     RESERVED),
    (r'\*',                    RESERVED),
    (r'/',                     RESERVED),
    (r'<=',                    RESERVED),
    (r'<',                     RESERVED),
    (r'>=',                    RESERVED),
    (r'>',                     RESERVED),
    (r'!=',                    RESERVED),
    (r'=',                     RESERVED),
    (r'and',                   RESERVED),
    (r'or',                    RESERVED),
    (r'not',                   RESERVED),
    (r'if',                    RESERVED),
    (r'then',                  RESERVED),
    (r'else',                  RESERVED),
    (r'while',                 RESERVED),
    (r'do',                    RESERVED),
    (r'end',                   RESERVED),
    (r'[0-9]+',                INT),
    (r'[A-Za-z][A-Za-z0-9_]*', ID),
]

def imp_lex(characters):
    return lex(characters, token_exprs)
                                
class Node:
    def __init__(self, key):
        self.left = None
        self.right = None
        self.val = key
        #self.mathml = ''

    # Traverse preorder
    def traversePreOrder(self):
        mathml = '' 
        if self.val == '+':
           mathml += '&lt;apply&gt; &lt;plus/&gt;' 
        if self.val == '-':
           mathml += '&lt;apply&gt;' 
        if self.val == '*':
           mathml += '&lt;apply&gt; &lt;times/&gt;' 
        if self.val == '/':
           mathml += '&lt;apply&gt; &lt;divide/&gt;'                              
        if not (self.val in ['+', '-', '*', '/']):
           mathml = mathml + '&lt;ci&gt;' + self.val + '&lt;/ci&gt;'
            
        #print(self.val, end=' ')
        
        if self.left:
            mathml += self.left.traversePreOrder()
        if self.right:
            mathml += self.right.traversePreOrder()
        if self.val in ['+', '-', '*', '/']:
           mathml += '&lt;/apply&gt;'
        return mathml

    # Traverse inorder
    def traverseInOrder(self):
        if self.left:
            self.left.traverseInOrder()
        if self.right:
            self.right.traverseInOrder()

    # Traverse postorder
    def traversePostOrder(self):
        if self.left:
            self.left.traversePostOrder()
        if self.right:
            self.right.traversePostOrder()

class InfixToMathML:
    def __init__(self, infix):
        self.tokenPtr = 0
        self.token = None
        self.tokens = imp_lex(infix)
        
    def nextToken(self):
        if self.tokenPtr >= len (self.tokens):
            self.token = [0, 'None']
        else:   
            self.token = self.tokens[self.tokenPtr]
            self.tokenPtr += 1
    
    def factor (self):
        if self.token[1] == 'ID':
            n = Node(self.token[0])
            self.nextToken()
            return n
        if self.token[0] == '(':
            self.nextToken()
            n = self.expression()
    
            if self.token[0] != ')':
                raise Exception ('Missing right parenthesis')
            self.nextToken()
            return n

    def term (self):
        n1 = self.factor()
        while self.token[0] in ['*', '/']:
            op = self.token[0]
            self.nextToken()
            n2 = self.factor()
            n3 = Node (op)   
            n3.left = n1
            n3.right = n2
            n1 = n3
        return n1
                   
    def expression(self):
        n1 = self.term()
        while self.token[0] in ['+', '-']:
            op = self.token[0]
            self.nextToken()
            n2 = self.term()
            n3 = Node (op)   
            n3.left = n1
            n3.right = n2
            n1 = n3      
        return n1
        
    def stmt (self):
        return self.expression()   

    def parse (self):
        self.nextToken()
        return self.stmt ()
    
    def getMathML (self):
        tree = self.parse ()
        mathml = '&lt;math xmlns="http://www.w3.org/1998/Math/MathML"&gt;' + '\n'
        m = tree.traversePreOrder()
        mathml += m + '\n' + '&lt;/math&gt;'
        return mathml
 
class antToSbml:
    def __init__(self, antStr):
        self.antStr = antStr
    
        self.reactions = []

        self.header = '&lt;?xml version="1.0" encoding="UTF-8"?&gt;' + '\n' 
        self.header += '&lt;sbml xmlns="http://www.sbml.org/sbml/level3/version1/core" level="3" version="1"&gt;' + '\n'
        self.header += '&lt;model extentUnits="mole" timeUnits="second"&gt;' + '\n'
        
        self.trailer = '&lt;/model>' + '\n'
        self.trailer += '&lt;/sbml>'

        self.header += '&lt;listOfUnitDefinitions&gt;' + '\n'
        self.header += '&lt;unitDefinition id="per_second"&gt;' + '\n'
        self.header += '&lt;listOfUnits&gt;' + '\n'
        self.header += '&lt;unit kind="second" exponent="-1" scale="0" multiplier="1"/&gt;' + '\n'
        self.header += '&lt;/listOfUnits&gt;' + '\n'
        self.header += '&lt;/unitDefinition&gt;' + '\n'
        self.header += '&lt;unitDefinition id="litre_per_mole_second"&gt;' + '\n'
        self.header += '&lt;listOfUnits&gt;' + '\n'
        self.header += '&lt;unit kind="mole" exponent="-1" scale="0" multiplier="1"/&gt;' + '\n'
        self.header += '&lt;unit kind="litre" exponent="1" scale="0" multiplier="1"/&gt;' + '\n'
        self.header += '&lt;unit kind="second" exponent="-1" scale="0" multiplier="1"/&gt;' + '\n'
        self.header += '&lt;/listOfUnits&gt;' + '\n'
        self.header += '&lt;/unitDefinition&gt;' + '\n'
        self.header += '&lt;/listOfUnitDefinitions&gt;' + '\n'

        self.compartment = '&lt;listOfCompartments&gt;' + '\n'
        self.compartment += '&lt;compartment id="comp" size="1" spatialDimensions="3" units="litre" constant="true"/&gt;' + '\n'
        self.compartment += '&lt;/listOfCompartments&gt;' + '\n'

        self.sbmlStr = self.header + self.compartment

        self.speciesList = []
        self.parameterList = []
        
    def addToSpeciesList(self, id):
        if not (id in self.speciesList):
           self.speciesList.append (id)
        
    def my_split(self, s, seps):
        res = [s]
        for sep in seps:
            s, res = res, []
            for seq in s:
                res += seq.split(sep)
        return res
        
    def makeSpecies (self, id):
        astr = ''
        astr = astr + '&lt;species compartment="comp" '
        astr = astr + "id=\"" + id + '\" '
        astr += ' initialConcentration="1"'
        astr += ' hasOnlySubstanceUnits="false" substanceUnits="mole"'
        astr += ' constant="false" boundaryCondition="false"'
        astr = astr + '/&gt;' + '\n'
        return astr

    def getSBML(self):
        lines = self.antStr.split('\n');  
        for line in lines:
            line = line.replace("\n", " ")
            line = line.strip()
            if line != '':
                P1 = line.split (';')
                P2 = P1[0].split ('->')
                reactants = P2[0].split ('+')
                products = P2[1].split ('+')

                expression = P1[1].strip()

                for idx, r in enumerate(reactants):
                    reactants[idx] = r.strip ()
                for idx, r in enumerate(reactants):
                    if r[0].isdigit():
                       reactants[idx] = r.split (' ')
                    else:
                       reactants[idx] = [1, reactants[idx]]
                    self.addToSpeciesList (reactants[idx][1])

                for idx, r in enumerate(products):
                    products[idx] = r.strip ()
                for idx, r in enumerate(products):
                    if r[0].isdigit():
                       products[idx] = r.split (' ')
                    else:
                       products[idx] = [1, products[idx]]
                    self.addToSpeciesList (products[idx][1])

                # Get the parameter list
                terms = self.my_split(expression, '+/-*()')
                for s in terms:
                    if not (s in self.speciesList):
                        self.parameterList.append (s)

                self.reactions.append ([reactants, products, expression])
 
        self.sbmlStr += '&lt;listOfSpecies&gt;' + '\n'
        astr = ''
        for id in self.speciesList:
             astr = astr + self.makeSpecies(id)

        self.sbmlStr += astr
        self.sbmlStr += '&lt;/listOfSpecies&gt;' + '\n'

        self.sbmlStr += '&lt;listOfParameters&gt;' + '\n'
        for p in self.parameterList:
            self.sbmlStr += '&lt;parameter id="' + p + '" value = "0.0" units="dimensionless" constant="true"/&gt;' + '\n'
        self.sbmlStr += '&lt;/listOfParameters&gt;' + '\n'

        self.sbmlStr += '&lt;listOfReactions&gt;' + '\n'

        astr = ''
        for idx1, r in enumerate (self.reactions):
                rid = 'J' + str (idx1)
                astr = astr + '&lt;reaction id="' + rid + '"'
                astr = astr + ' reversible="true" fast="false"&gt;' + '\n'
                astr = astr + '&lt;listOfReactants&gt;' + '\n'
                for idx2, rt in enumerate (r[0]):
                    astr = astr + '&lt;speciesReference species="'
                    astr = astr + rt[1] + '" stoichiometry="'
                    astr += str (rt[0]) + '" constant="true"/&gt;' + '\n'   
                astr = astr + '&lt;/listOfReactants&gt;' + '\n' 

                astr = astr + '&lt;listOfProducts&gt;' + '\n'
                for idx2, rt in enumerate (r[1]):
                    astr = astr + '&lt;speciesReference species="'
                    astr = astr + rt[1] + '" stoichiometry="'
                    astr += str (rt[0]) + '" constant="true"/&gt;' + '\n'   
                astr = astr + '&lt;/listOfProducts&gt;' + '\n'  

                astr += '&lt;kineticLaw&gt;' + '\n'
                p = InfixToMathML(r[2])
                astr += p.getMathML ()
                astr += '&lt;/kineticLaw&gt;' + '\n'
    
                astr += '&lt;/reaction&gt;' + '\n'

        self.sbmlStr += astr + '&lt;/listOfReactions&gt;' + '\n'

        self.sbmlStr = self.sbmlStr + self.trailer
        return self.sbmlStr
</py-script>
    
    <py-config>
    </py-config>  
                                                                                                                              
 <div class="form-group purple-border">
   <h5>Type your model here Y:</h5>
  <textarea class="form-control" id="antimony" rows="8">
   A + B -> C; k1*A*B
   C -> D; k2*C
  </textarea>
</div>       
                                                                                                                            
      <button id="ClickMe" class = "btn btn-primary" py-click="getSBML()">Generate SBML</button> 

      <h5>The SBML is:</h5>
            
      <py-script> 
         def getSBML():
             antStr = Element('antimony').element.value                  
             m = antToSbml (antStr)
             sbml = m.getSBML()
             sbml = sbml.replace('\n', '<br />')
             Element('sbml_output').element.innerText = sbml
        </py-script>
        
 <div class="form-group purple-border">
  <textarea class="form-control" id="sbml_output" style="white-space: pre-wrap; rows="20" height:250px !important;>
  </textarea>
</div>
                                                                                         
<button class = "btn btn-primary" id="CopyToClipboard" onclick="copytoclipboard()">Copy to Clipboard</button>

</body>

